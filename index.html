<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iboyVoice V1 - Room & Account System</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://files.catbox.moe/3tqe1i.jpeg');
            background-size: cover; background-position: center; background-attachment: fixed;
            font-family: 'Rajdhani', sans-serif; color: white; min-height: 100vh;
        }
        .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; }
        .input-iboy { background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 12px; color: #00d2ff; outline: none; text-align: center; font-weight: bold; width: 100%; }
        .btn-main { background: linear-gradient(45deg, #3a7bd5, #00d2ff); border-radius: 14px; transition: 0.3s; font-weight: bold; cursor: pointer; border: none; width: 100%; padding: 1rem; text-transform: uppercase; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 210, 255, 0.4); }
        .pfp-box { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #00d2ff; overflow: hidden; margin: 0 auto; position: relative; background: #111; }
        .hidden { display: none; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <div id="account-setup" class="glass p-10 w-full max-w-md text-center shadow-2xl hidden">
        <h1 class="text-4xl font-bold mb-2 text-blue-400">CREATE ACCOUNT</h1>
        <p class="text-xs text-gray-400 mb-8 uppercase tracking-widest">Daftar Akun iboyVoice</p>
        <div class="mb-6">
            <div class="pfp-box">
                <img id="setup-pfp-preview" src="" class="w-full h-full object-cover hidden">
                <div id="setup-pfp-icon" class="mt-7 text-4xl">ðŸ‘¤</div>
                <label for="pfp-input" class="absolute bottom-0 w-full bg-black/70 text-[9px] py-1 cursor-pointer">UPLOAD FOTO</label>
            </div>
        </div>
        <input type="text" id="setup-nickname" placeholder="NICKNAME KAMU" class="input-iboy text-xl mb-4">
        <button onclick="registerAccount()" class="btn-main">SIMPAN AKUN</button>
    </div>

    <div id="dashboard" class="glass p-10 w-full max-w-md text-center shadow-2xl hidden">
        <div class="flex flex-col items-center mb-6">
            <div class="w-20 h-20 rounded-full border-2 border-blue-400 overflow-hidden mb-3">
                <img id="dash-pfp" src="" class="w-full h-full object-cover">
            </div>
            <h2 class="text-3xl font-bold italic">Halo, <span id="dash-nick" class="text-blue-400"></span>!</h2>
            <button onclick="logout()" class="text-[10px] text-gray-500 underline uppercase mt-1">Ganti Akun</button>
        </div>
        <div class="space-y-4">
            <button onclick="viewCreate()" class="btn-main py-5 text-xl"><i class="fa-solid fa-plus mr-2"></i> CREATE ROOM</button>
            <button onclick="viewJoin()" class="btn-main py-5 text-xl bg-gray-800 border-2 border-blue-500/50"> <i class="fa-solid fa-door-open mr-2"></i> JOIN BY ID</button>
        </div>
    </div>

    <div id="create-room-view" class="glass p-10 w-full max-w-sm text-center shadow-2xl hidden">
        <h2 class="text-2xl font-bold text-blue-400 mb-6 uppercase">Buat Room Baru</h2>
        <input type="text" id="room-name-input" placeholder="NAMA ROOM (MISAL: SURVIVAL)" class="input-iboy mb-4 uppercase">
        <button onclick="processCreate()" class="btn-main mb-2">GENERATE ID</button>
        <button onclick="checkAuth()" class="text-xs text-gray-500">KEMBALI</button>
    </div>

    <div id="join-room-view" class="glass p-10 w-full max-w-sm text-center shadow-2xl hidden">
        <h2 class="text-2xl font-bold text-green-400 mb-6 uppercase">Masuk Room</h2>
        <input type="text" id="join-id-input" placeholder="MASUKKAN ID ROOM" class="input-iboy mb-4 text-2xl uppercase tracking-widest">
        <button onclick="processJoin()" class="btn-main bg-green-500 mb-2">GABUNG SEKARANG</button>
        <button onclick="checkAuth()" class="text-xs text-gray-500">KEMBALI</button>
    </div>

    <div id="voice-lobby" class="hidden w-full max-w-4xl">
        <div class="glass p-6 mb-6 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-left">
                <h2 id="lobby-room-name" class="text-3xl font-bold text-white uppercase">NAMA ROOM</h2>
                <div class="flex items-center gap-2 bg-black/40 p-2 rounded-lg mt-2">
                    <span class="text-xs text-gray-400 uppercase">ID:</span>
                    <span id="lobby-room-id" class="text-2xl font-mono font-bold text-blue-400 tracking-widest"></span>
                    <button onclick="copyID()" class="text-blue-300 ml-2"><i class="fa-solid fa-copy"></i></button>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="mute-btn" onclick="toggleMute()" class="btn-main px-6 py-2 text-xs">MIC: ON</button>
                <button onclick="location.reload()" class="bg-red-500/20 text-red-400 border border-red-500/50 px-4 py-2 rounded-xl text-xs font-bold">EXIT</button>
            </div>
        </div>
        <div id="player-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
        <p id="conn-log" class="text-center mt-6 text-[10px] text-gray-500 uppercase italic">Mencari teman di room...</p>
    </div>

    <input type="file" id="pfp-input" accept="image/*" hidden>

    <script>
        let account = { nick: "", pfp: "" };
        let myStream, peer, gun, roomID, roomName, myFullID;
        let activePeers = new Set();

        // --- ACCOUNT LOGIC ---
        function checkAuth() {
            const saved = localStorage.getItem('iboy_account');
            hideScreens();
            if (saved) {
                account = JSON.parse(saved);
                document.getElementById('dash-nick').innerText = account.nick;
                document.getElementById('dash-pfp').src = account.pfp || "";
                document.getElementById('dashboard').classList.remove('hidden');
            } else {
                document.getElementById('account-setup').classList.remove('hidden');
            }
        }

        function registerAccount() {
            const n = document.getElementById('setup-nickname').value.trim();
            if (!n) return alert("Nickname wajib diisi!");
            account.nick = n;
            localStorage.setItem('iboy_account', JSON.stringify(account));
            checkAuth();
        }

        document.getElementById('pfp-input').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 100; canvas.height = 100;
                    canvas.getContext('2d').drawImage(img, 0, 0, 100, 100);
                    account.pfp = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('setup-pfp-preview').src = account.pfp;
                    document.getElementById('setup-pfp-preview').classList.remove('hidden');
                    document.getElementById('setup-pfp-icon').classList.add('hidden');
                };
                img.src = reader.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // --- NAVIGATION ---
        function viewCreate() { hideScreens(); document.getElementById('create-room-view').classList.remove('hidden'); }
        function viewJoin() { hideScreens(); document.getElementById('join-room-view').classList.remove('hidden'); }
        function hideScreens() { ['account-setup', 'dashboard', 'create-room-view', 'join-room-view', 'voice-lobby'].forEach(id => document.getElementById(id).classList.add('hidden')); }

        // --- ROOM LOGIC ---
        function processCreate() {
            roomName = document.getElementById('room-name-input').value.trim();
            if(!roomName) return alert("Isi Nama Room!");
            roomID = Math.random().toString(36).substring(2, 8).toUpperCase();
            initVoice();
        }

        function processJoin() {
            roomID = document.getElementById('join-id-input').value.trim().toUpperCase();
            if(roomID.length < 4) return alert("ID Room Salah!");
            initVoice();
        }

        async function initVoice() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                hideScreens();
                document.getElementById('voice-lobby').classList.remove('hidden');
                document.getElementById('lobby-room-id').innerText = roomID;
                
                // Signaling Server Jalur Ganda
                gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://peer.wall.org/gun']);
                
                if(roomName) { // Jika Host, simpan Nama Room
                    gun.get('rooms').get(roomID).put({ name: roomName });
                    document.getElementById('lobby-room-name').innerText = roomName;
                } else { // Jika Joiner, tarik Nama Room
                    gun.get('rooms').get(roomID).on(data => {
                        if(data && data.name) document.getElementById('lobby-room-name').innerText = data.name;
                    });
                }

                initPeer();
            } catch (err) { alert("Mic Error! Pakai HTTPS."); }
        }

        function initPeer() {
            myFullID = `iboyv14-${roomID}-${account.nick}-${Math.floor(Math.random()*999)}`;
            peer = new Peer(myFullID, { config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] } });

            peer.on('open', id => {
                addPlayerUI(account.nick, true, id, null, account.pfp);
                syncLobby(id);
            });

            peer.on('call', call => {
                call.answer(myStream);
                call.on('stream', stream => {
                    const n = call.peer.split('-')[2];
                    addPlayerUI(n, false, call.peer, stream);
                });
            });
        }

        function syncLobby(myId) {
            const lobby = gun.get('lobby-' + roomID);
            lobby.get(myId).put({ id: myId, name: account.nick, pfp: account.pfp, last: Date.now() });
            setInterval(() => lobby.get(myId).put({ last: Date.now() }), 4000);

            lobby.map().on((user, id) => {
                if (!user || id === myId || Date.now() - user.last > 10000) return;
                if (!activePeers.has(id)) {
                    const call = peer.call(id, myStream);
                    call.on('stream', stream => addPlayerUI(user.name, false, id, stream, user.pfp));
                    activePeers.add(id);
                    document.getElementById('conn-log').innerText = "Teman terhubung!";
                }
            });
        }

        function addPlayerUI(name, isMe, pid, stream, pfp) {
            if (document.getElementById('card-' + pid)) return;
            const grid = document.getElementById('player-grid');
            const card = document.createElement('div');
            card.id = 'card-' + pid;
            card.className = "glass p-4 text-center border-t-4 " + (isMe ? "border-blue-400" : "border-green-400");
            card.innerHTML = `
                <div class="w-14 h-14 mx-auto mb-2 rounded-full overflow-hidden bg-gray-800 border border-white/20">
                    <img src="${pfp || ''}" class="w-full h-full object-cover ${pfp ? '' : 'hidden'}">
                    <div class="mt-3 text-xl font-bold ${pfp ? 'hidden' : ''}">${name[0].toUpperCase()}</div>
                </div>
                <div class="text-sm font-bold uppercase truncate">${name}</div>
            `;
            grid.appendChild(card);
            if (stream && !isMe) {
                const a = document.createElement('audio'); a.autoplay = true; a.srcObject = stream;
                card.appendChild(a);
            }
        }

        function copyID() { navigator.clipboard.writeText(roomID); alert("ID Room Disalin!"); }
        
        let muted = false;
        function toggleMute() {
            muted = !muted; myStream.getAudioTracks()[0].enabled = !muted;
            document.getElementById('mute-btn').innerText = muted ? "MIC: OFF" : "MIC: ON";
            document.getElementById('mute-btn').style.opacity = muted ? "0.5" : "1";
        }

        checkAuth();
    </script>
</body>
  </html>
  
